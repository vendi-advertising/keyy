var keyy_send_command_admin_ajax=function(e,n,t,o,r,i){r="undefined"==typeof r?30:r,o="undefined"==typeof o||o;var y={type:"POST",url:keyy.ajax_url,timeout:1e3*r,data:{action:"keyy_ajax",subaction:e,nonce:keyy.ajax_nonce,data:n},success:function(e){if(o){try{var n=JSON.parse(e)}catch(r){return console.log(r),console.log(e),void alert(keyy.error_unexpected_response)}"undefined"!=typeof t&&t(n)}else"undefined"!=typeof t&&t(e)},error:function(n,t,o){"function"==typeof i?i(n,t,o):(console.log("keyy_send_command ("+e+"): error: "+t+" ("+o+")"),console.log(n))}};jQuery.ajax(y)},js_date=new Date,keyy_connection_token_zero_time_at=Math.round(js_date.getTime()/1e3),keyy_login_token_zero_time_at=keyy_connection_token_zero_time_at;jQuery(document).ready(function(e){if(Keyy=Keyy(keyy_send_command_admin_ajax),keyy.hasOwnProperty("connection_token")&&Keyy.set_connection_token(keyy.connection_token),Keyy.parse_query_string.keyy_token_id){var n={value:Keyy.parse_query_string.keyy_token_id,expires_after:285,origin:"autologin"};Keyy.parse_query_string.hasOwnProperty("keyy_password")&&"required"==Keyy.parse_query_string.keyy_password&&(n.password_policy="required",Keyy.parse_query_string.hasOwnProperty("keyy_user_login")&&(n.user_login=Keyy.parse_query_string.keyy_user_login)),Keyy.set_login_token(n)}else keyy.hasOwnProperty("login_token")&&Keyy.set_login_token(keyy.login_token);keyy.hasOwnProperty("connection_result")&&Keyy.set_connection_result(keyy.connection_result),keyy.hasOwnProperty("connected")&&Keyy.set_connection_status(keyy.connected)});var Keyy=function(e){var n,t,o=jQuery,r=null,i=-1,y=keyy.context,_=null,s=null,c=null,a=null;this.parse_query_string=function(){for(var e={},n=window.location.search.substring(1),t=n.split("&"),o=t.length,r=0;r<o;r++){var i=t[r].split("=");if("undefined"==typeof e[i[0]])e[i[0]]=decodeURIComponent(i[1]);else if("string"==typeof e[i[0]]){var y=[e[i[0]],decodeURIComponent(i[1])];e[i[0]]=y}else e[i[0]].push(decodeURIComponent(i[1]))}return e}(),this.save_settings=function(n,t,r,i){i="undefined"==typeof i?"user":i,"undefined"!=typeof t&&o(t).show();var y=Keyy.gather_settings(n),_={type:i,data:y};"user-via-site-admin"==i&&(_.user_id=o(".keyy_user_settings").data("user_id")),e("save_settings",_,function(e){if("undefined"!=typeof t&&o(t).hide(),"undefined"!=typeof r&&o(r).show().delay(5e3).fadeOut(),e&&e.hasOwnProperty("errors")){for(var n=0,y=e.errors.length;n<y;n++){var _='<div class="error">'+e.errors[n]+"</div>",s=o("#keuy-admin-body-container").length>0?"#keyy-admin-body-container":o("#keyy-admin-settings").length>0?"#keyy-admin-settings":".keyy_user_settings_container";"user-via-site-admin"==i&&(s=".keyy_user_results .keyy-site-admin-user-settings"),Keyy.temporarily_display_notice(_,s)}console.log(e.errors)}})},this.gather_settings=function(e){var n=o(e+" input[name!='action'], "+e+" textarea, "+e+" select").serialize();return o.each(o(e+" input[type=checkbox]").filter(function(e){return 0==o(this).prop("checked")}),function(e,t){var r="0";n+="&"+o(t).attr("name")+"="+r}),n},this.temporarily_display_notice=function(e,n,t){n="undefined"==typeof n?"#keyy-admin-body-container":n,t="undefined"==typeof t?15:t,o(e).hide().prependTo(n).slideDown("slow").delay(1e3*t).slideUp("slow",function(){o(this).remove()})},this.stop_login_polling=function(){null!==a&&(clearTimeout(a),a=null)},this.set_connection_result=function(e){r=e},this.set_connection_status=function(e){i=e},this.get_connection_status=function(){return i},this.set_connection_token=function(e){n=e;var t=n.expires_after-5;t<1&&(t=1),null!==_&&clearTimeout(_),_=setTimeout(function(){_=null,o(".keyy_qrcode").html(keyy.replacing),Keyy.replace_connection_token()},1e3*t)},this.get_login_token=function(){return t},this.set_login_token=function(e){t=e;var n=t.expires_after-5;n<1&&(n=1),null!==s&&clearTimeout(s),s=setTimeout(function(){s=null,o(".keyy_qrcode").html(keyy.replacing),Keyy.replace_login_token()},1e3*n)},this.replace_connection_token=function(){e("get_connection_token",{force_refresh:1},function(e){if(e.hasOwnProperty("value")){var n=new Date;keyy_connection_token_zero_time_at=Math.round(n.getTime()/1e3),Keyy.set_connection_token(e),Keyy.show_qr_code(".keyy_qrcode",y)}else!1!==e&&(console.log("Keyy: get_connection_token: unexpected result"),console.log(e))},!0,30,function(e,n,t){o(".keyy_qrcode").html(keyy.refresh),console.log(e)})},this.replace_login_token=function(){e("get_fresh_login_token",null,function(e){if(e.hasOwnProperty("value")){var n=new Date;keyy_login_token_zero_time_at=Math.round(n.getTime()/1e3),Keyy.set_login_token(e),Keyy.show_qr_code(".keyy_qrcode",y)}else console.log("Keyy: get_fresh_login_token: unexpected result"),console.log(e)},!0,30,function(e,n,t){o(".keyy_qrcode").html(keyy.refresh),console.log(e)})},this.poll_for_result=function(n,o,y){var y="undefined"==typeof y?10:y,_={};if(y>0&&(_.wait=y),"login"==n)_.token_id=t.value,e("get_token_state",_,function(e){if(e.hasOwnProperty("state")){if("undefined"!=typeof o){var n=o(e,t);n&&Keyy.stop_login_polling()}}else!1!==e&&(console.log("Keyy: get_token_state: unexpected result:"),console.log(e))});else{var s=i?"disconnect":"connect";r&&r.hasOwnProperty("time")&&(_.since_time=r.time),e("get_"+s+"ion_result",_,function(e){if(e&&e.hasOwnProperty("connection_token")&&Keyy.set_connection_token(e.connection_token),i)e.hasOwnProperty("connected")&&!e.connected&&(Keyy.set_connection_status(!1),"undefined"!=typeof o&&o(e));else{if(!e.hasOwnProperty("time"))return;if(r&&r.hasOwnProperty("time")&&e.time<=r.time)return;e.hasOwnProperty("connected")&&Keyy.set_connection_status(e.connected),Keyy.set_connection_result(e),"undefined"!=typeof o&&o(e)}})}};var l=function(e){if(e<=4)return{poll_for:6,next_poll_at:4};if(e<=30){var n=Math.max(6+e-e%6-1,11);return{poll_for:3,next_poll_at:n}}var n=6+e-e%6-1;return e<=120?{poll_for:2,next_poll_at:n}:{poll_for:0,next_poll_at:n}};return this.register_listener=function(e,n){var t,o=0;"connect"==e?c=setInterval(function(){o++,t=l(o),o>=t.next_poll_at&&Keyy.poll_for_result(e,n,t.poll_for)},1e3):"login"==e&&(a=setInterval(function(){o++,t=l(o),o>=t.next_poll_at&&Keyy.poll_for_result(e,n,t.poll_for)},1e3))},this.render_qr_code=function(e,n){console.log("Keyy: QR URL: "+n);var t=kjua({render:"image",text:n,ecLevel:"H",crisp:!1});o(e).addClass("keyy_qrcode").data("qrcode",n).empty();var r=document.querySelector(e);r&&r.appendChild(t),keyy.debug&&o(e).append('<div style="clear: left; overflow: scroll;">'+n+"</div>")},this.show_qr_code=function(r,i){i="undefined"==typeof i?"login":i,y=i;var _=keyy.qr_url+"?context="+i,s=new Date,c=Math.round(s.getTime()/1e3),a=c-keyy_connection_token_zero_time_at,l="connect"==i?n.expires_after:t.expires_after,u="connect"==i?"get_connection_token":"get_fresh_login_token",d="connect"==i?{force_refresh:1}:null;if(a+2>l)e(u,d,function(e){if(e.hasOwnProperty("value")){var y=new Date;"connect"==i?(keyy_connection_token_zero_time_at=Math.round(y.getTime()/1e3),Keyy.set_connection_token(e)):(keyy_login_token_zero_time_at=Math.round(y.getTime()/1e3),Keyy.set_login_token(e));var s="connect"==i?n:t;_=_+"&token="+s.value,o(r).data("keyy_form_identifier")&&(_=_+"&form_id="+o(r).data("keyy_form_identifier")),Keyy.render_qr_code(r,_)}});else{var f="connect"==i?n:t;_=_+"&token="+f.value,o(r).data("keyy_form_identifier")&&(_=_+"&form_id="+o(r).data("keyy_form_identifier")),Keyy.render_qr_code(r,_)}},this};